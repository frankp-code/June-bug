<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junies Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
    <!-- D3.js for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 100%;
            overflow-x: auto;
        }
        .table-container {
            min-width: 640px; /* Ensure table is wide enough for all columns */
        }
        /* New tab button styles for consistency with save/load buttons */
        .tab-button {
            @apply bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200;
            margin-right: 0.5rem; /* Space between buttons */
            margin-bottom: 0.5rem; /* For wrapping on small screens */
            flex-grow: 1; /* Allow buttons to grow */
            text-align: center;
        }
        .tab-button.active {
            @apply bg-blue-600 hover:bg-blue-700;
        }
        /* Flex container for tabs to allow wrapping */
        .tab-buttons-container {
            @apply flex flex-wrap justify-center sm:justify-start gap-2 mb-4;
        }

        .graph-container {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 2rem; /* space-y-8 between graphs */
        }
        .graph-title {
            @apply text-lg font-semibold text-gray-800 mb-4;
        }
        .axis text {
            font-size: 10px;
        }
        .axis path, .axis line {
            fill: none;
            stroke: #d1d5db; /* gray-300 */
            shape-rendering: crispEdges;
        }
        .grid .tick line {
            stroke: #e5e7eb; /* gray-200 */
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .line {
            fill: none;
            stroke: #2563eb; /* blue-600 */
            stroke-width: 2px;
        }
        .dot {
            fill: #2563eb; /* blue-600 */
            stroke: #ffffff; /* white */
            stroke-width: 1.5px;
        }

        /* Styles for star rating */
        .star-rating {
            display: flex; /* Use flexbox for better alignment */
            flex-direction: row-reverse; /* Stars from right to left */
            justify-content: flex-end; /* Align to the right */
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 1.5rem; /* Large stars */
            color: #d1d5db; /* Gray stars by default */
            cursor: pointer;
            padding: 0 0.1rem;
            transition: color 0.2s;
        }
        /* When a radio is checked, color it and all subsequent labels (to its left in RTL) */
        .star-rating input[type="radio"]:checked ~ label {
            color: #fcd34d; /* Yellow for selected stars */
        }
        /* On hover, color the hovered star and all subsequent labels (to its left in RTL) */
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fcd34d; /* Yellow for hovered stars */
        }
        /* Ensure checked stars stay yellow even when hovering over other stars */
        .star-rating input[type="radio"]:checked ~ label:hover,
        .star-rating input[type="radio"]:checked ~ label:hover ~ label {
            color: #fcd34d;
        }
        .star-rating.read-only label {
            cursor: default;
        }
        /* For read-only, only checked stars should be yellow, no hover effect */
        .star-rating.read-only label:hover,
        .star-rating.read-only label:hover ~ label {
            color: #d1d5db; /* Keep gray on hover for read-only */
        }
        .star-rating.read-only input[type="radio"]:checked ~ label {
            color: #fcd34d; /* Keep yellow for checked stars in read-only */
        }

        /* Responsive table cell styling */
        .activity-cell {
            padding: 0.5rem 0.25rem; /* Smaller padding for mobile */
            text-align: center;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .activity-cell {
                padding: 0.5rem 1rem; /* Restore larger padding for desktop */
            }
        }
        .activity-cell input[type="checkbox"] {
            margin: auto; /* Center checkboxes */
        }
        .activity-cell select {
            width: 4rem; /* Fixed width for dropdowns on mobile */
            margin: auto;
        }
        .notes-cell input[type="text"] {
            width: 8rem; /* Fixed width for notes on mobile */
            margin: auto;
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .activity-cell select, .notes-cell input[type="text"] {
                width: auto; /* Auto width on desktop */
            }
        }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto bg-white shadow-xl rounded-2xl p-4 sm:p-8">
        <h1 class="text-3xl sm:text-4xl font-semibold text-center mb-2 text-gray-800">Junies Journal</h1>
        <p class="text-center text-gray-500 mb-6">What fun things will she do today</p>
        
        <!-- Date and save/load controls -->
        <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
            <div class="flex items-center space-x-2">
                <label for="logDate" class="text-gray-700 font-medium">Select Date:</label>
                <input type="date" id="logDate" class="form-input rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
            </div>
            <div class="flex space-x-2">
                <button id="saveBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 opacity-50 cursor-not-allowed" disabled>
                    Save
                </button>
                <button id="loadBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 opacity-50 cursor-not-allowed" disabled>
                    Load
                </button>
            </div>
        </div>

        <!-- User ID and status message -->
        <div class="text-center mb-4 text-sm text-gray-600">
            <p>Your User ID: <span id="userIdDisplay" class="font-mono bg-gray-200 rounded-md px-2 py-1">Loading...</span></p>
            <p id="statusMessage" class="mt-2 text-green-600 font-semibold"></p>
        </div>

        <!-- Tabs -->
        <div class="tab-buttons-container">
            <button id="dailyLogTabBtn" class="tab-button active">Daily Log</button>
            <button id="summaryTabBtn" class="tab-button inactive">Summary</button>
            <button id="trainingTabBtn" class="tab-button inactive">Training</button>
        </div>

        <!-- Tab Content: Daily Log -->
        <div id="dailyLogTabContent" class="tab-content">
            <div class="table-container">
                <table class="w-full text-sm text-left text-gray-500 rounded-lg overflow-hidden">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3 px-2 sm:px-4 rounded-tl-lg">Time</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Nap</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Wake Up</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Food</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Hand Feeding</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Walk</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Wee</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Poo</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 text-center">Sick</th>
                            <th scope="col" class="py-3 px-2 sm:px-4 rounded-tr-lg">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="activityTableBody">
                        <!-- Table rows will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tab Content: Summary -->
        <div id="summaryTabContent" class="tab-content hidden p-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daily Summary</h2>
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6">
                <p class="text-lg text-gray-700 mb-2">Total Sleep Duration: <span id="totalSleepDuration" class="font-bold text-blue-600">0 hours 0 minutes</span></p>
                <div id="sleepPeriodsList" class="mt-4 text-sm text-gray-600 mb-4">
                    <!-- Individual sleep periods will be listed here -->
                </div>
                <p class="text-lg text-gray-700 mb-2">Total Food (combined): <span id="totalFoodCombined" class="font-bold text-blue-600">0g</span></p>
                <p class="text-lg text-gray-700 mb-2">Wee Count: <span id="weeCountSummary" class="font-bold text-blue-600">0</span></p>
                <p class="text-lg text-gray-700 mb-2">Poo Count: <span id="pooCountSummary" class="font-bold text-blue-600">0</span></p>
                <p class="text-lg text-gray-700">Sick Count: <span id="sickCountSummary" class="font-bold text-blue-600">0</span></p>
            </div>

            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Weekly Activity Trends</h2>
            <div id="weeklyGraphsContainer" class="space-y-8">
                <!-- Graphs will be rendered here by D3.js -->
            </div>
        </div>

        <!-- Tab Content: Training -->
        <div id="trainingTabContent" class="tab-content hidden p-4">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Daily Training Log</h2>
            <button id="addTrainingEntryBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200 mb-4 opacity-50 cursor-not-allowed" disabled>
                Add Training Entry
            </button>
            <div id="trainingEntriesContainer" class="space-y-4">
                <!-- Training entries will be added here -->
            </div>
        </div>

    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modalMessage"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCcjbaaVUTX5Ib-sEotEaCFFEtpFEDyO0g",
            authDomain: "juniesjournalapp.firebaseapp.com",
            projectId: "juniesjournalapp",
            storageBucket: "juniesjournalapp.firebasestorage.app",
            messagingSenderId: "17313748223",
            appId: "1:17313748223:web:12f543c01c6d0f062e28ca"
        };
        
        // When running on GitHub Pages, we don't have __app_id from the Canvas.
        // We can derive it from the projectId or use a static one.
        const appId = firebaseConfig.projectId || 'junies-journal-github'; // Using project ID or a custom ID
        
        // On GitHub Pages, there is no __initial_auth_token.
        // We will rely on signInAnonymously in initFirebase().
        const initialAuthToken = null; // No initial token from Canvas

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, userId;
        let isAuthReady = false; // Flag to check if Firebase is ready
        // Updated activities array to include 'Hand Feeding' in the desired order
        const activityTypes = ['Nap', 'Wake Up', 'Food', 'Hand Feeding', 'Walk', 'Wee', 'Poo', 'Sick']; // Renamed for clarity
        // Activities for which dropdowns are used
        const dropdownActivities = ['Food', 'Hand Feeding'];
        let currentDayData = []; // Store the currently loaded daily log data for activity tab
        let currentTrainingData = []; // Store the currently loaded daily log data for training tab

        // UI elements
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const logDateInput = document.getElementById('logDate');
        const activityTableBody = document.getElementById('activityTableBody');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const statusMessage = document.getElementById('statusMessage');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        // Tab elements
        const dailyLogTabBtn = document.getElementById('dailyLogTabBtn');
        const summaryTabBtn = document.getElementById('summaryTabBtn');
        const trainingTabBtn = document.getElementById('trainingTabBtn'); // New tab button
        const dailyLogTabContent = document.getElementById('dailyLogTabContent');
        const summaryTabContent = document.getElementById('summaryTabContent');
        const trainingTabContent = document.getElementById('trainingTabContent'); // New tab content
        const totalSleepDurationSpan = document.getElementById('totalSleepDuration');
        const sleepPeriodsList = document.getElementById('sleepPeriodsList');
        const totalFoodCombinedSpan = document.getElementById('totalFoodCombined');
        const weeCountSummarySpan = document.getElementById('weeCountSummary');
        const pooCountSummarySpan = document.getElementById('pooCountSummary');
        const sickCountSummarySpan = document.getElementById('sickCountSummary');
        const weeklyGraphsContainer = document.getElementById('weeklyGraphsContainer');

        // Training tab elements
        const addTrainingEntryBtn = document.getElementById('addTrainingEntryBtn'); // New button
        const trainingEntriesContainer = document.getElementById('trainingEntriesContainer'); // New container


        // --- Utility Functions ---

        // Show a custom modal message
        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Hide the custom modal
        closeModalBtn.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Convert time string (e.g., "7:15 AM") to minutes from midnight
        function timeToMinutes(timeString) {
            const [time, ampm] = timeString.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (ampm === 'PM' && hours !== 12) {
                hours += 12;
            } else if (ampm === 'AM' && hours === 12) {
                hours = 0; // 12 AM is 0 hours
            }
            return hours * 60 + minutes;
        }

        // Convert minutes to a human-readable duration string
        function formatDuration(totalMinutes) {
            if (totalMinutes < 0) return "0 hours 0 minutes";
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            return `${hours} hours ${minutes} minutes`;
        }

        /**
         * Helper function to fetch log data for a specific date from a given collection.
         * @param {string} dateString - The date in YYYY-MM-DD format.
         * @param {string} collectionName - The name of the Firestore collection (e.g., 'puppyLogs', 'trainingLogs').
         * @returns {Promise<Array|null>} - A promise that resolves to the log data or null if not found/error.
         */
        async function getLogForDate(dateString, collectionName) {
            if (!db || !userId || !dateString || !collectionName) {
                return null;
            }
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, collectionName, dateString);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().log;
                }
                return null;
            } catch (e) {
                console.error(`Error fetching log for date ${dateString} from ${collectionName}: `, e);
                return null;
            }
        }

        // --- Firebase Initialization ---

        // Initialize Firebase and set up auth listener
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    try { 
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = userId;
                            isAuthReady = true;
                            // Enable buttons and remove opacity
                            saveBtn.disabled = false;
                            loadBtn.disabled = false;
                            addTrainingEntryBtn.disabled = false; // Enable add training button
                            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            loadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                            addTrainingEntryBtn.classList.remove('opacity-50', 'cursor-not-allowed'); // Remove opacity from add training button

                            // Load data for today after auth is ready
                            await loadAllDataForDate(logDateInput.value); // Load both activity and training logs
                        } else {
                            // Sign in anonymously if not authenticated
                            await signInAnonymously(auth);
                        }
                    } catch (errorInAuthCallback) {
                        console.error("Error inside onAuthStateChanged callback:", errorInAuthCallback);
                        userIdDisplay.textContent = 'Error (callback)';
                        showMessage('Error', 'An error occurred during authentication callback. Check console.');
                    }
                });
            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                userIdDisplay.textContent = 'Error';
                showMessage('Error', 'Failed to initialize the app. Please try again later.');
            }
        }

        // --- Table Generation and Data Handling for Daily Log Tab ---

        /**
         * Creates a new table row for a given time.
         * @param {string} timeString - The time for the row (e.g., "12:00 AM").
         */
        function createTableRow(timeString) {
            const row = document.createElement('tr');
            row.className = 'bg-white border-b hover:bg-gray-50';
            row.dataset.time = timeString; // Store time for identification

            // Time cell
            const timeCell = document.createElement('td');
            timeCell.className = `py-2 px-2 sm:px-4 font-medium text-gray-900 whitespace-nowrap`;
            timeCell.textContent = timeString;
            row.appendChild(timeCell);

            // Activity cells with checkboxes or dropdowns
            activityTypes.forEach(activity => { // Loop through activityTypes for columns
                const cell = document.createElement('td');
                cell.className = 'activity-cell'; // Apply responsive styling

                if (dropdownActivities.includes(activity)) {
                    const select = document.createElement('select');
                    select.className = 'block text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 mx-auto';
                    select.dataset.activity = activity;
                    select.dataset.inputType = 'dropdown'; // Custom data attribute for type
                    
                    let option = document.createElement('option');
                    option.value = '0'; // Store numeric value
                    option.textContent = '0g';
                    select.appendChild(option);

                    for (let i = 5; i <= 80; i += 5) {
                        option = document.createElement('option');
                        option.value = `${i}`; // Store numeric value
                        option.textContent = `${i}g`;
                        select.appendChild(option);
                    }
                    cell.appendChild(select);
                } else {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 mx-auto';
                    checkbox.dataset.activity = activity;
                    cell.appendChild(checkbox);
                }
                row.appendChild(cell);
            });

            // Notes cell
            const notesCell = document.createElement('td');
            notesCell.className = 'notes-cell'; // Apply responsive styling
            const notesInput = document.createElement('input');
            notesInput.type = 'text';
            notesInput.placeholder = 'Add a note...';
            notesInput.className = 'block w-full text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 mx-auto';
            notesInput.dataset.activity = 'Notes'; // Add data-activity for notes
            notesCell.appendChild(notesInput);
            row.appendChild(notesCell);

            return row;
        }
        
        // Generate the 24-hour table with 15-minute intervals
        function generateEmptyTable() {
            activityTableBody.innerHTML = '';
            const tableStartDate = new Date();
            tableStartDate.setHours(0, 0, 0, 0); // Start at midnight
            
            // Loop for 24 hours (24 * 4 = 96 intervals)
            for (let i = 0; i < 24 * 4; i++) {
                const hour = tableStartDate.getHours();
                const minute = tableStartDate.getMinutes();
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = (hour % 12) === 0 ? 12 : hour % 12;
                const timeString = `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;

                const newRow = createTableRow(timeString);
                activityTableBody.appendChild(newRow);
                
                // Add 15 minutes to the time
                tableStartDate.setMinutes(tableStartDate.getMinutes() + 15);
            }
            currentDayData = []; // Clear current data when generating empty table
            calculateAndDisplaySummary(); // Recalculate summary for empty data
        }
        
        // Save data to Firestore (Activity Log)
        async function saveData() {
            if (!isAuthReady) {
                showMessage('Error', 'App is not ready. Please wait a moment.');
                return;
            }

            const selectedDate = logDateInput.value;
            if (!selectedDate) {
                showMessage('Error', 'Please select a date before saving.');
                return;
            }

            const dataToSave = [];
            const rows = activityTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const time = row.querySelector('td:first-child').textContent;
                const rowData = { time, activities: {} };
                
                // Process dropdowns and checkboxes
                activityTypes.forEach(activity => { // Use activityTypes here
                    const inputElement = row.querySelector(`[data-activity="${activity}"]`);
                    if (inputElement) {
                        if (inputElement.dataset.inputType === 'dropdown') {
                            rowData.activities[activity] = parseInt(inputElement.value) || 0; // Store numeric value
                        } else {
                            rowData.activities[activity] = inputElement.checked; // Store boolean
                        }
                    }
                });
                
                const notesInput = row.querySelector('[data-activity="Notes"]'); // Select by data-activity for notes
                rowData.notes = notesInput ? notesInput.value : '';
                
                dataToSave.push(rowData);
            });
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'puppyLogs', selectedDate);
                await setDoc(docRef, { log: dataToSave });
                currentDayData = dataToSave; // Update local cache
                await calculateAndDisplaySummary(); // Update summary after saving (await it now)
                showMessage('Success', 'Daily log saved successfully!');
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage('Error', 'Failed to save log. Please try again.');
            }
        }

        // Load data from Firestore (Activity Log)
        async function loadData() {
            if (!isAuthReady) {
                return;
            }

            const selectedDate = logDateInput.value;
            if (!selectedDate) {
                showMessage('Error', 'Please select a date before loading.');
                return;
            }

            try {
                const savedData = await getLogForDate(selectedDate, 'puppyLogs'); // Use helper function

                // Re-generate empty table first to ensure correct structure for mapping data
                generateEmptyTable(); 

                if (savedData) {
                    if (savedData.length === activityTableBody.children.length) {
                        const rows = activityTableBody.querySelectorAll('tr');
                        rows.forEach((row, index) => {
                            const rowData = savedData[index];
                            // Process dropdowns and checkboxes
                            activityTypes.forEach(activity => { // Use activityTypes here
                                const inputElement = row.querySelector(`[data-activity="${activity}"]`);
                                if (inputElement) {
                                    if (inputElement.dataset.inputType === 'dropdown') {
                                        inputElement.value = (rowData.activities[activity] || 0); // Set numeric value
                                    } else {
                                        inputElement.checked = rowData.activities[activity] || false; // Set checked status
                                    }
                                }
                            });
                            const notesInput = row.querySelector('[data-activity="Notes"]');
                            if (notesInput) notesInput.value = rowData.notes || '';
                        });
                        currentDayData = savedData; // Update local cache
                        showMessage('Success', 'Activity log loaded successfully!');
                    } else {
                        showMessage('Error', 'Activity data format mismatch. Generating empty log.');
                        currentDayData = []; // Reset current day data
                    }
                } else {
                    showMessage('Info', 'No activity log found for this date. Starting a new, blank log.');
                    currentDayData = []; // Reset current day data
                }
            } catch (e) {
                console.error("Error loading activity document: ", e);
                showMessage('Error', 'Failed to load activity log. Please check your network connection.');
            } finally {
                // Always recalculate summary after attempting to load data
                await calculateAndDisplaySummary(); // Await summary calculation
            }
        }
        
        // --- Summary Calculation ---

        async function calculateAndDisplaySummary() {
            let totalSleepMinutes = 0;
            let sleepPeriods = [];
            let potentialSleepStartEntry = null;
            const selectedDateString = logDateInput.value;

            let totalDailyFoodGrams = 0;
            let dailyWeeCount = 0;
            let dailyPooCount = 0;
            let dailySickCount = 0;

            if (!currentDayData || currentDayData.length === 0 || !selectedDateString) {
                totalSleepDurationSpan.textContent = "0 hours 0 minutes";
                sleepPeriodsList.innerHTML = "<p class='text-gray-500'>No sleep data available for this day.</p>";
                totalFoodCombinedSpan.textContent = "0g";
                weeCountSummarySpan.textContent = "0";
                pooCountSummarySpan.textContent = "0";
                sickCountSummarySpan.textContent = "0";
            } else {
                const currentDayDate = new Date(selectedDateString);
                currentDayDate.setHours(0, 0, 0, 0);

                for (let i = 0; i < currentDayData.length; i++) {
                    const entry = currentDayData[i];
                    const entryMinutes = timeToMinutes(entry.time);
                    const entryDateTime = new Date(currentDayDate);
                    entryDateTime.setHours(Math.floor(entryMinutes / 60), entryMinutes % 60, 0, 0);

                    const isNap = entry.activities.Nap;
                    const isWakeUp = entry.activities['Wake Up'];

                    if (isNap && potentialSleepStartEntry === null) {
                        potentialSleepStartEntry = { time: entry.time, dateTime: entryDateTime };
                    } else if (isWakeUp && potentialSleepStartEntry !== null) {
                        const sleepEndDateTime = entryDateTime;
                        const durationMs = sleepEndDateTime.getTime() - potentialSleepStartEntry.dateTime.getTime();
                        const durationMinutes = durationMs / (1000 * 60);

                        if (durationMinutes > 0) {
                            totalSleepMinutes += durationMinutes;
                            sleepPeriods.push({ start: potentialSleepStartEntry.time, end: entry.time, duration: durationMinutes });
                        }
                        potentialSleepStartEntry = null;
                    }

                    if (entry.activities.Food !== undefined) {
                        totalDailyFoodGrams += (typeof entry.activities.Food === 'number' ? entry.activities.Food : 0);
                    }
                    if (entry.activities['Hand Feeding'] !== undefined) {
                        totalDailyFoodGrams += (typeof entry.activities['Hand Feeding'] === 'number' ? entry.activities['Hand Feeding'] : 0);
                    }
                    if (entry.activities.Wee) dailyWeeCount++;
                    if (entry.activities.Poo) dailyPooCount++;
                    if (entry.activities.Sick) dailySickCount++;
                }

                if (potentialSleepStartEntry !== null) {
                    const nextDay = new Date(currentDayDate);
                    nextDay.setDate(currentDayDate.getDate() + 1);
                    const nextDayDateString = nextDay.toISOString().split('T')[0];

                    let sleepEndDateTime = null;
                    let sleepEndTimeString = null;
                    let foundWakeUpNextDay = false;

                    const nextDayLog = await getLogForDate(nextDayDateString, 'puppyLogs');

                    if (nextDayLog && nextDayLog.length > 0) {
                        for (const nextDayEntry of nextDayLog) {
                            if (nextDayEntry.activities['Wake Up']) {
                                const nextDayEntryMinutes = timeToMinutes(nextDayEntry.time);
                                sleepEndDateTime = new Date(nextDay);
                                sleepEndDateTime.setHours(Math.floor(nextDayEntryMinutes / 60), nextDayEntryMinutes % 60, 0, 0);
                                sleepEndTimeString = nextDayEntry.time + " (next day)";
                                foundWakeUpNextDay = true;
                                break;
                            }
                        }
                    }

                    if (foundWakeUpNextDay && sleepEndDateTime !== null) {
                        const durationMs = sleepEndDateTime.getTime() - potentialSleepStartEntry.dateTime.getTime();
                        const durationMinutes = durationMs / (1000 * 60);

                        if (durationMinutes > 0) {
                            totalSleepMinutes += durationMinutes;
                            sleepPeriods.push({ start: potentialSleepStartEntry.time, end: sleepEndTimeString, duration: durationMinutes });
                        }
                    } else {
                        const endOfDayDateTime = new Date(currentDayDate);
                        endOfDayDateTime.setHours(23, 59, 0, 0);
                        
                        const durationMs = endOfDayDateTime.getTime() - potentialSleepStartEntry.dateTime.getTime();
                        const durationMinutes = durationMs / (1000 * 60);

                        if (durationMinutes > 0) {
                            totalSleepMinutes += durationMinutes;
                            sleepPeriods.push({ start: potentialSleepStartEntry.time, end: "End of Day", duration: durationMinutes });
                        }
                    }
                }

                totalSleepDurationSpan.textContent = formatDuration(totalSleepMinutes);
                totalFoodCombinedSpan.textContent = `${totalDailyFoodGrams}g`;
                weeCountSummarySpan.textContent = dailyWeeCount.toString();
                pooCountSummarySpan.textContent = dailyPooCount.toString();
                sickCountSummarySpan.textContent = dailySickCount.toString();

                if (sleepPeriods.length > 0) {
                    sleepPeriodsList.innerHTML = `<h3 class="font-medium text-gray-700 mb-2">Individual Sleep Periods:</h3>`;
                    const ul = document.createElement('ul');
                    ul.className = 'list-disc list-inside text-gray-600 space-y-1';
                    sleepPeriods.forEach(period => {
                        const li = document.createElement('li');
                        li.textContent = `From ${period.start} to ${period.end} (${formatDuration(period.duration)})`;
                        ul.appendChild(li);
                    });
                    sleepPeriodsList.appendChild(ul);
                } else {
                    sleepPeriodsList.innerHTML = "<p class='text-gray-500'>No explicit Nap/Wake Up cycles recorded for sleep.</p>";
                }
            }

            // --- Weekly Activity Data Processing ---
            const weeklyData = [];
            const activitiesForGraphs = ['Nap', 'Food', 'Hand Feeding', 'Walk', 'Wee', 'Poo', 'Sick'];
            const currentDate = new Date(selectedDateString);
            currentDate.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) {
                const loopDate = new Date(currentDate);
                loopDate.setDate(currentDate.getDate() - i);
                const loopDateString = loopDate.toISOString().split('T')[0];
                const dayName = loopDate.toLocaleDateString('en-US', { weekday: 'short' });

                const dailyCounts = { date: dayName, fullDate: loopDateString };
                activitiesForGraphs.forEach(activity => dailyCounts[activity] = 0);

                const logForLoopDate = await getLogForDate(loopDateString, 'puppyLogs');

                if (logForLoopDate) {
                    logForLoopDate.forEach(entry => {
                        activitiesForGraphs.forEach(activity => {
                            if (dropdownActivities.includes(activity)) {
                                dailyCounts[activity] += (typeof entry.activities[activity] === 'number' ? entry.activities[activity] : 0);
                            } else if (activity !== 'Wake Up') {
                                if (entry.activities[activity]) {
                                    dailyCounts[activity]++;
                                }
                            }
                        });
                    });
                }
                weeklyData.push(dailyCounts);
            }
            
            renderWeeklyGraphs(weeklyData, activitiesForGraphs);
        }

        // --- D3.js Graphing Function ---
        function renderWeeklyGraphs(data, activitiesToGraph) {
            weeklyGraphsContainer.innerHTML = ''; // Clear previous graphs

            const margin = { top: 20, right: 30, bottom: 40, left: 40 };
            const width = Math.max(300, weeklyGraphsContainer.clientWidth) - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;

            activitiesToGraph.forEach(activity => {
                if (activity === 'Wake Up') return;

                const graphDiv = document.createElement('div');
                graphDiv.className = 'graph-container';
                graphDiv.innerHTML = `<h3 class="graph-title">${activity} per Day</h3>`;
                weeklyGraphsContainer.appendChild(graphDiv);

                const svg = d3.select(graphDiv)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .append('g')
                    .attr('transform', `translate(${margin.left},${margin.top})`);

                const xScale = d3.scaleBand()
                    .range([0, width])
                    .domain(data.map(d => d.date))
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .range([height, 0])
                    .domain([0, d3.max(data, d => d[activity]) + 1]);

                svg.append('g')
                    .attr('class', 'x axis')
                    .attr('transform', `translate(0,${height})`)
                    .call(d3.axisBottom(xScale));

                svg.append('g')
                    .attr('class', 'y axis')
                    .call(d3.axisLeft(yScale).ticks(yScale.domain()[1] > 0 ? yScale.domain()[1] : 1).tickFormat(d3.format("d")));

                svg.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(yScale)
                        .ticks(yScale.domain()[1] > 0 ? yScale.domain()[1] : 1)
                        .tickSize(-width)
                        .tickFormat("")
                    );

                svg.append('path')
                    .datum(data)
                    .attr('class', 'line')
                    .attr('d', d3.line()
                        .x(d => xScale(d.date) + xScale.bandwidth() / 2)
                        .y(d => yScale(d[activity]))
                    );

                svg.selectAll('.dot')
                    .data(data)
                    .enter().append('circle')
                    .attr('class', 'dot')
                    .attr('cx', d => xScale(d.date) + xScale.bandwidth() / 2)
                    .attr('cy', d => yScale(d[activity]))
                    .attr('r', 4);
            });
        }

        // --- Training Tab Functions ---

        /**
         * Renders training entries in the training tab.
         * @param {Array<Object>} trainingData - Array of training entry objects {type: string, rating: number}.
         */
        function renderTrainingEntries(trainingData) {
            trainingEntriesContainer.innerHTML = ''; // Clear existing entries

            if (!trainingData || trainingData.length === 0) {
                trainingEntriesContainer.innerHTML = "<p class='text-gray-500'>No training entries for this day.</p>";
                return;
            }

            trainingData.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 p-4 bg-gray-50 rounded-lg shadow-sm';
                entryDiv.dataset.entryIndex = index; // Used for updating/deleting

                // Training Type Input
                const typeInput = document.createElement('input');
                typeInput.type = 'text';
                typeInput.placeholder = 'Training Type';
                typeInput.value = entry.type || '';
                typeInput.className = 'flex-grow block w-full sm:w-auto text-sm rounded-lg border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500';
                typeInput.addEventListener('change', (e) => {
                    currentTrainingData[index].type = e.target.value;
                });
                entryDiv.appendChild(typeInput);

                // Star Rating
                const starRatingDiv = document.createElement('div');
                starRatingDiv.className = 'star-rating flex-shrink-0';
                starRatingDiv.dataset.entryIndex = index;

                for (let i = 5; i >= 1; i--) {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.id = `star-${index}-${i}`;
                    radio.name = `rating-${index}`;
                    radio.value = i;
                    radio.checked = (entry.rating === i);
                    radio.addEventListener('change', (e) => {
                        currentTrainingData[index].rating = parseInt(e.target.value);
                    });
                    starRatingDiv.appendChild(radio);

                    const label = document.createElement('label');
                    label.htmlFor = `star-${index}-${i}`;
                    label.textContent = '⭐'; // Star character
                    starRatingDiv.appendChild(label);
                }
                entryDiv.appendChild(starRatingDiv);

                // Delete Button
                const deleteButton = document.createElement('button');
                deleteButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm shadow-sm transition-colors duration-200 flex-shrink-0';
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deleteTrainingEntry(index));
                entryDiv.appendChild(deleteButton);

                trainingEntriesContainer.appendChild(entryDiv);
            });
        }

        // Add a new blank training entry
        function addTrainingEntry() {
            currentTrainingData.push({ type: '', rating: 0 });
            renderTrainingEntries(currentTrainingData);
        }

        // Delete a training entry by index
        function deleteTrainingEntry(index) {
            currentTrainingData.splice(index, 1);
            renderTrainingEntries(currentTrainingData); // Re-render to update indices and display
        }

        // Save training data to Firestore
        async function saveTrainingData() {
            if (!isAuthReady) {
                showMessage('Error', 'App is not ready. Please wait a moment.');
                return;
            }

            const selectedDate = logDateInput.value;
            if (!selectedDate) {
                showMessage('Error', 'Please select a date before saving.');
                return;
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'trainingLogs', selectedDate);
                await setDoc(docRef, { log: currentTrainingData });
                showMessage('Success', 'Training log saved successfully!');
            } catch (e) {
                console.error("Error saving training document: ", e);
                showMessage('Error', 'Failed to save training log. Please try again.');
            }
        }

        // Load training data from Firestore
        async function loadTrainingData() {
            if (!isAuthReady) {
                return;
            }

            const selectedDate = logDateInput.value;
            if (!selectedDate) {
                showMessage('Error', 'Please select a date before loading.');
                return;
            }

            try {
                const savedData = await getLogForDate(selectedDate, 'trainingLogs');
                if (savedData) {
                    currentTrainingData = savedData;
                    showMessage('Success', 'Training log loaded successfully!');
                } else {
                    currentTrainingData = [];
                    showMessage('Info', 'No training log found for this date. Starting a new, blank log.');
                }
            } catch (e) {
                console.error("Error loading training document: ", e);
                showMessage('Error', 'Failed to load training log. Please check your network connection.');
            } finally {
                renderTrainingEntries(currentTrainingData);
            }
        }

        // --- Combined Data Loading ---
        async function loadAllDataForDate(dateString) {
            await loadData(); // Load activity log
            await loadTrainingData(); // Load training log
            // If the current tab is summary or training, update its content
            if (dailyLogTabContent.classList.contains('hidden') && summaryTabContent.classList.contains('hidden')) {
                showTab('trainingTab'); // If training tab was active, re-render
            } else if (dailyLogTabContent.classList.contains('hidden')) {
                 showTab('summaryTab'); // If summary tab was active, re-render
            } else {
                 showTab('dailyLogTab'); // Re-render daily log if active
            }
        }


        // --- Tab Switching Logic ---

        let activeTabId = 'dailyLogTab'; // Track the currently active tab

        function showTab(tabId) {
            activeTabId = tabId; // Update active tab tracker

            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('inactive');
            });

            // Show the selected tab content
            document.getElementById(tabId + 'Content').classList.remove('hidden');
            // Activate the selected tab button
            document.getElementById(tabId + 'Btn').classList.remove('inactive');
            document.getElementById(tabId + 'Btn').classList.add('active');

            // Logic to update content based on active tab
            if (tabId === 'summaryTab') {
                calculateAndDisplaySummary();
            } else if (tabId === 'trainingTab') {
                renderTrainingEntries(currentTrainingData); // Re-render current training data
            } else if (tabId === 'dailyLogTab') {
                // No specific action needed, table is already generated/loaded
            }
        }

        // --- Event Listeners and Initial Setup ---
        
        // Event listeners for save/load buttons and date changes
        saveBtn.addEventListener('click', async () => {
            // Save data for currently active tab
            if (activeTabId === 'dailyLogTab') {
                await saveData();
            } else if (activeTabId === 'trainingTab') {
                await saveTrainingData();
            } else { // If on summary tab, save both if data was modified implicitly
                await saveData();
                await saveTrainingData();
            }
        });

        loadBtn.addEventListener('click', async () => {
            await loadAllDataForDate(logDateInput.value);
        });

        logDateInput.addEventListener('change', async () => {
            if (isAuthReady) {
                await loadAllDataForDate(logDateInput.value); // Load both logs when date changes
            }
        });

        // Tab button event listeners
        dailyLogTabBtn.addEventListener('click', () => showTab('dailyLogTab'));
        summaryTabBtn.addEventListener('click', () => showTab('summaryTab'));
        trainingTabBtn.addEventListener('click', () => showTab('trainingTab')); // New tab listener
        addTrainingEntryBtn.addEventListener('click', addTrainingEntry); // New training button listener
        
        // Set today's date as default
        function setDefaultDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            logDateInput.value = `${year}-${month}-${day}`;
        }
        
        // Initial setup on window load
        window.onload = async function() {
            setDefaultDate();
            generateEmptyTable(); // Generate the activity table structure first
            await initFirebase(); // initFirebase calls loadAllDataForDate() after auth
            showTab('dailyLogTab'); // Show the daily log tab by default
        };
    </script>
</body>
</html>
